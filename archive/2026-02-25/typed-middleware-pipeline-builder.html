<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TypeDrop — Typed Middleware Pipeline Builder</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/fontsource/fonts/0x-proto@latest/latin-400-normal.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/fontsource/fonts/0x-proto@latest/latin-700-normal.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css">
  <link rel="icon" href="../../misc/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="../../style.css">
</head>
<body>
  <main>
    <header>
      <h1><a href="../../index.html" style="color: inherit; text-decoration: none;">TypeDrop</a></h1>
      <p class="tagline">2026-02-25 Challenge</p>
    </header>

    <section class="challenge-card">
      <div class="challenge-header">
        <span class="challenge-date">2026-02-25</span>
        <span class="badge medium">Medium</span>
      </div>
      <h2>Typed Middleware Pipeline Builder</h2>
      <p>You're building the request-handling core of an internal HTTP gateway. Middleware functions transform a typed context object one step at a time — the challenge is composing them into a pipeline where each middleware's output type flows into the next middleware's input type, all enforced at compile time.</p>
      <div class="challenge-goals">
        <h3>Goals</h3>
        <ul>
          <li>Implement `Awaited_&lt;T&gt;` and `PipelineOutput&lt;Middlewares&gt;` as conditional types that use `infer` to extract inner and last-middleware output types.</li>
          <li>Implement `compose` and `composeAsync` as fully generic functions that chain two middlewares with no manual type annotations at call sites.</li>
          <li>Implement `runPipeline` to execute middlewares sequentially, returning a typed `PipelineResult` discriminated union that captures both success and per-step failure.</li>
          <li>Define the `Brand` helper and `AuthedContext` branded type, then implement `withAuth` as a middleware that narrows a plain `RequestContext` into an `AuthedContext` or throws.</li>
        </ul>
      </div>
      <div class="code-block">
        <div class="code-block-header">
          <span class="dot red"></span>
          <span class="dot yellow"></span>
          <span class="dot green"></span>
          <span class="code-block-title">challenge.ts</span>
        </div>
        <pre><code class="language-typescript">/** A single middleware: receives a context of type In, returns Out. */
type Middleware&lt;In, Out&gt; = (ctx: In) =&gt; Out;

/** Unwrap a Promise&lt;T&gt; → T; leave non-promise types unchanged. */
type Awaited_&lt;T&gt; = /* TODO: conditional type using infer */;

/** Infer the output type of the last middleware in a tuple. */
type PipelineOutput&lt;
  Middlewares extends readonly Middleware&lt;unknown, unknown&gt;[]
&gt; = /* TODO: recursive conditional type */;

/** Discriminated union returned by runPipeline. */
type PipelineResult&lt;T&gt; =
  | { ok: true; value: T }
  | { ok: false; error: string; step: number };

/** Chain two middlewares — intermediate type is fully inferred. */
declare function compose&lt;A, B, C&gt;(
  f: Middleware&lt;A, B&gt;,
  g: Middleware&lt;B, C&gt;
): Middleware&lt;A, C&gt;;

/** Run an ordered array of middlewares, catching per-step errors. */
declare function runPipeline(
  initial: unknown,
  middlewares: Array&lt;Middleware&lt;unknown, unknown&gt;&gt;
): PipelineResult&lt;unknown&gt;;
</code></pre>
      </div>
      <details class="challenge-hints-details">
        <summary>Hints (click to reveal)</summary>
      <div class="challenge-hints">
        <h3>Hints</h3>
        <ul>
          <li>For `PipelineOutput`, use a variadic tuple pattern: `Middlewares extends [...infer _Init, infer Last]` to grab only the final element, then extract its output with a second `infer`.</li>
          <li>A branded type is just an intersection with a phantom property: `T &amp; { readonly __brand: B }` — this makes two structurally identical types nominally distinct.</li>
          <li>In `runPipeline`, keep a `current: unknown` variable and iterate with a `for` loop so you can track the step index when catching errors.</li>
        </ul>
      </div>
      </details>
      <div class="challenge-docs">
        <h3>Useful resources</h3>
        <ul>
          <li><a href="https://www.typescriptlang.org/docs/handbook/2/conditional-types.html" target="_blank" rel="noopener noreferrer">TypeScript Handbook: Conditional Types</a></li>
          <li><a href="https://www.typescriptlang.org/docs/handbook/2/conditional-types.html#inferring-within-conditional-types" target="_blank" rel="noopener noreferrer">TypeScript Handbook: Inferring Within Conditional Types</a></li>
          <li><a href="https://www.typescriptlang.org/docs/handbook/2/generics.html" target="_blank" rel="noopener noreferrer">TypeScript Handbook: Generics</a></li>
          <li><a href="https://basarat.gitbook.io/typescript/main-1/nominaltyping" target="_blank" rel="noopener noreferrer">TypeScript Deep Dive: Branded Types</a></li>
        </ul>
      </div>
      <div class="cta-row">
        <a class="cta-button cta-primary" href="https://stackblitz.com/github/niltonheck/typedrop/tree/challenge/2026-02-25" target="_blank" rel="noopener noreferrer">
          <img class="sb-icon" src="https://cdn.simpleicons.org/stackblitz/e0e0e0" alt=""> StackBlitz
        </a>
        <a class="cta-button" href="https://codesandbox.io/p/devbox/github/niltonheck/typedrop/tree/challenge/2026-02-25" target="_blank" rel="noopener noreferrer">
          <img class="csb-icon" src="https://cdn.simpleicons.org/codesandbox/e0e0e0" alt=""> CodeSandbox
        </a>
      </div>
      <div class="clone-section">
        <h3>Or clone locally</h3>
        <div class="clone-box">
          <code id="clone-cmd">git clone -b challenge/2026-02-25 https://github.com/niltonheck/typedrop.git</code>
          <button class="clone-copy-btn" onclick="navigator.clipboard.writeText(document.getElementById('clone-cmd').textContent).then(()=>{this.textContent='Copied!';this.classList.add('copied');setTimeout(()=>{this.textContent='Copy';this.classList.remove('copied')},2000)})">Copy</button>
        </div>
      </div>
    </section>

    <footer>
      <p>
        <a href="../../index.html">&larr; Today's challenge</a>
        &middot;
        <a href="../../archive.html">Archive</a>
      </p>
    </footer>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-typescript.min.js"></script>
  <script data-goatcounter="https://niltonheck.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>