name: Generate Daily Challenge

on:
  schedule:
    - cron: '0 6 * * *' # Daily at 6:00 UTC
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Generate challenge
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: npx tsx scripts/generate.ts

      - name: Create and push challenge branch
        run: |
          DATE=$(date -u +%Y-%m-%d)
          BRANCH="challenge/${DATE}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stash challenges.json update (belongs to main, not the branch)
          git stash push challenges.json -- 2>/dev/null || true

          # Remove existing branch if re-running on the same day
          git push origin --delete "${BRANCH}" 2>/dev/null || true

          # Create challenge branch with only the output files
          git checkout -b "${BRANCH}"
          cp challenge-output/* .
          cp -r challenge-output/.codesandbox .
          git add challenge.ts challenge.test.ts README.md tsconfig.json package.json .codesandbox/
          git commit -m "challenge: ${DATE}"
          git push origin "${BRANCH}"

          # Switch back to main and apply stashed changes
          git checkout main
          git stash pop 2>/dev/null || true

      - name: Update site on main
        run: |
          DATE=$(date -u +%Y-%m-%d)

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          npx tsx scripts/inject.ts
          git add challenges.json index.html archive.html archive/
          git commit -m "challenge: ${DATE} â€” update site"
          git push origin main

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

  deploy:
    needs: generate
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
